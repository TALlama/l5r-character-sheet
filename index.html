<!doctype html>
<html class="no-js" lang="">

  <head>
    <meta charset="utf-8">
    <title></title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="manifest" href="site.webmanifest">
    <link rel="apple-touch-icon" href="icon.png">
    <!-- Place favicon.ico in the root directory -->

    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/l5r.css">

    <meta name="theme-color" content="#fafafa">
  </head>

  <body>
    <svg class='hidden' viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
      <symbol id="success" width="10" height="10" viewBox="0 0 100 100" fill='green'>
        <polygon points="80,77 85,70 88,63 90,56 90.5,51 90.5,45 90,42 88,36 85,30 81,24 75,18 71,15 66,12 59,10 54,9 44,9 34,11 28,13 20,18 15,24 12,30 10,34 6.5,35 6,41 7,52  9,61 14,80 20,88 40,94 50,96 60,96 65,93 68,87 68,83 66,80 64,79 62,78 59,78 55,79 51,83 44,85 35,83 30,80 20,70 15,60 13,45 16,39 18,35 20,30 25,23 30,19 40,14 50,13 60,14 70,19 80,28 86,45 85,65 80,77" />
      </symbol>
  
      <symbol id="explode" width="10" height="10" viewBox="0 0 100 100" fill='teal'>
        <polygon points="15,70 20,78 30,86 40,89 50,91 60,90 70,87 75,81 76,73 75,64 71,58 68,58 62,59 60,60 58,62 55,68 57,75 59,76 59,78 50,82 40,83 30,81 20,76" />
        <polygon transform="rotate(119 49 51)" points="15,70 20,78 30,86 40,89 50,91 60,90 70,87 75,81 80,73 77,64 73,58 68,58 62,59 60,60 58,62 55,68 57,75 59,76 59,78 50,82 40,83 30,81 20,76" />
        <polygon transform="rotate(244 50.5 49)" points="15,70 20,78 30,86 40,89 50,91 62,90 70,87 75,81 80,73 79,64 73,59 68,58 62,59 60,60 58,62 55,68 57,75 59,76 59,78 50,82 40,83 30,81 20,76" />
      </symbol>
  
      <symbol id="strife" width="10" height="10" viewBox="0 0 100 100" fill='red'>
        <path d="M 41.20815 19.022556 L 32.4 23.4 L 20.2 31.4 L 12.4 43.2 L 10 57.398496 L 14.2 74.6 L 25.2 84.6 L 40.04367 89.8797 L 46.09898 89.3985 L 49.01019 84.22556 L 45.52 76.24 L 46.419565 71.92181 L 56.659565 64.24181 L 54.250364 73.5188 L 55.88064 81.218045 L 67.75837 90 L 76.60844 85.78947 L 86.15721 71.11278 L 89.8 56.6 L 80.8 44 L 68.2 34.6 L 55.8 24.8 L 63.2 35.4 L 79.4 49.4 L 84 58 L 78.82096 71.35338 L 69.38865 81.218045 L 66.710335 81.33835 L 63.56623 80.61654 L 59.024745 75.08271 L 59.13945 71.50677 L 62.28355 63.206016 L 62.4 60.8 L 57.699565 59.521806 L 50.988065 61.88271 L 45.16565 67.17594 L 40.975255 70.27068 L 41.20815 76.16541 L 40.88 82.16 L 29.8 80.8 L 19.2 71.8 L 14.89083 58.601504 L 15.6 48.6 L 19.4 40.8 L 27.2 33.6 L 32.24 30.16 L 46.68122 26.2406 L 54.01747 22.99248 L 55.76419 17.218045 C 55.76419 17.218045 54.71616 11.443609 54.71616 11.323308 C 54.71616 11.203008 49.359534 10 49.359534 10 L 45.749636 13.849624 Z" />
      </symbol>
  
      <symbol id="opportunity" width="10" height="10" viewBox="0 0 100 100" fill='rebeccapurple'>
        <path d="M 49.60912 42.10959 L 47.00326 35.26656 L 48.02699 23.580777 L 55.100047 11.473883 L 60.96324 10 L 65.98883 13.895262 L 67.1987 21.369953 L 63.476035 26.63382 L 57.333644 26.528543 L 51.00512 32.10824 Z" />
        <path d="M 54.95114 45.945205 L 61.4658 37.945205 L 75.14658 34.438356 L 84.39739 34.547945 L 90 38.164384 L 89.34853 44.630137 L 84.2671 47.91781 L 79.96743 48.356164 L 76.188925 45.068493 L 75.92834 39.58904 L 66.93811 39.47945 L 62.50814 41.12329 Z" />
        <path d="M 51.824104 51.20548 L 62.37785 51.20548 L 78.27362 57.342466 L 85.96091 64.57534 L 88.56678 72.46575 L 85.96091 79.80822 L 79.96743 82.54795 L 73.19218 81.12329 L 72.01954 75.9726 L 74.49511 71.26027 L 77.75244 69.83562 L 74.88599 63.260274 L 65.37459 55.36986 Z" />
        <path d="M 50.260586 57.89041 L 57.557 66.43836 L 57.557 78.71233 L 51.9544 88.24658 L 46.35179 90 L 40.4886 88.57534 C 40.4886 88.57534 36.188925 83.64384 36.188925 83.53425 C 36.188925 83.42466 36.579805 77.83562 36.579805 77.83562 L 40.358306 74.87671 L 44.788274 72.90411 L 50.260586 74.547945 L 51.433225 75.9726 L 53.517915 71.80822 L 53.517915 66.21918 L 53.517915 63.58904 Z" />
        <path d="M 43.87622 51.534247 L 42.833876 60.739726 L 36.188925 67.09589 L 24.723127 72.46575 L 16.514658 71.47945 L 11.172638 67.86301 L 10 62.38356 L 12.605863 56.0274 L 17.166124 53.72603 L 22.37785 54.82192 L 24.85342 58.32877 L 27.980456 62.38356 L 34.104235 62.71233 L 39.055375 58.657534 Z" />
        <path d="M 43.87622 44.08219 L 37.62215 46.931507 L 26.677524 44.739726 L 18.859935 39.369863 L 16.514658 33.452055 L 16.514658 26.657534 L 17.557003 21.178082 L 22.638436 17.123288 L 27.459283 16.79452 L 30.9772 18.657534 L 32.540717 25.0137 L 30.325733 32.575342 L 28.762215 36.30137 L 31.628664 40.90411 L 36.579805 42.9863 Z" />
      </symbol>
  
      <!-- examples
        <use xlink:href="#success" x="0" y="0" width='100' height='100' />
        <use xlink:href="#explode" x="0" y="0" width='100' height='100' />
        <use xlink:href="#strife" x="0" y="0" width='100' height='100' />
        <use xlink:href="#opportunity" x="0" y="0" width='100' height='100' />
      -->
  
      <!-- guide: circle cx="50" cy="50" r="40" stroke='red' fill='none' opacity='.5' / -->
  
      <symbol id="ring-die" width='10' height='10' viewBox='0 0 100 100' stroke='black' fill='white'>
        <rect x="10" y="10" width="80" height="80" />
      </symbol>
      <symbol id="skill-die" width='10' height='10' viewBox='0 0 100 100' stroke='black' fill='white'>
        <path d="M 51 99 L 99 63 L 81 7 L 21 7 L 1 63 Z" transform='rotate(20 50 50) translate(2 1)' />
      </symbol>
  
      <symbol id='face--'></symbol>
      <symbol id='face-O'>
        <use xlink:href="#opportunity" x="10" y="10" width='80' height='80' />
      </symbol>
      <symbol id='face-OX'>
        <use xlink:href="#opportunity" x="14" y="14" width='46' height='46' />
        <use xlink:href="#strife" x="43" y="43" width='46' height='46' />
      </symbol>
      <symbol id='face-R'>
        <use xlink:href="#explode" x="10" y="10" width='80' height='80' />
      </symbol>
      <symbol id='face-RX'>
        <use xlink:href="#explode" x="14" y="14" width='46' height='46' />
        <use xlink:href="#strife" x="43" y="43" width='46' height='46' />
      </symbol>
      <symbol id='face-S'>
        <use xlink:href="#success" x="10" y="10" width='80' height='80' />
      </symbol>
      <symbol id='face-SO'>
        <use xlink:href="#success" x="14" y="14" width='46' height='46' />
        <use xlink:href="#opportunity" x="43" y="43" width='46' height='46' />
      </symbol>
      <symbol id='face-SX'>
        <use xlink:href="#success" x="14" y="14" width='46' height='46' />
        <use xlink:href="#strife" x="43" y="43" width='46' height='46' />
      </symbol>
  
      <use xlink:href="#skill-die" x="0" y="0" width='100' height='100' />
      <use xlink:href="#face-SX" x="0" y="0" width='100' height='100' />
    </svg>
    
    <article class='rollbox'>
      <header class='rollbox--header'>
        <label>Ring dice <input class='rollbox--ring' type='number' value='3'/></label>
        <label>Skill dice <input class='rollbox--skill' type='number' value='2'/></label>
        <button class='rollbox--trigger' >Roll!</button>
      </header>
      
      <article class='dice-tray rollbox--current-dice-tray'></article>
      <a href='#' class='rollbox--roll-exploding hidden' data-shown-if='exploding'>roll <span data-shows='exploding'>0</span> exploding</a>
      
      <dl class='rollbox--outcome'>
        <dt>keeps-left</dt>
        <dd><output class='rollbox--output' data-shows='keepsLeft'>3</output></dd>
        
        <dt class='hidden' data-shown-if='successes'>successes</dt>
        <dd class='hidden' data-shown-if='successes'><output class='rollbox--output' data-shows='successes'></output></dd>
        
        <dt class='hidden' data-shown-if='opportunities'>opportunities</dt>
        <dd class='hidden' data-shown-if='opportunities'><output class='rollbox--output' data-shows='opportunities'></output></dd>
        
        <dt class='hidden' data-shown-if='strife'>strife</dt>
        <dd class='hidden' data-shown-if='strife'><output class='rollbox--output' data-shows='strife'></output></dd>
        
        <dt class='hidden' data-shown-if='rerolls'>rerolls</dt>
        <dd class='hidden' data-shown-if='rerolls'><output class='rollbox--output' data-shows='rerolls'></output></dd>
      </dl>
      <!-- roll(document.querySelector("#ring").value, document.querySelector("#ring").value) -->
    </article>
    
    <script>
      class Rollable {
        get successes() { return this.maxCountOf('S'); }
        get exploding() { return this.maxCountOf('R'); }
        get opportunities() { return this.maxCountOf('O'); }
        get strife() { return this.maxCountOf('X'); }
        

        get rolledSuccesses() { return this.rolledCountOf('S'); }
        get rolledExploding() { return this.rolledCountOf('R'); }
        get rolledOpportunities() { return this.rolledCountOf('O'); }
        get rolledStrife() { return this.rolledCountOf('X'); }
        
        rolledCountOf(symbol) {
          return this.symbols.reduce((count, sym) => sym === symbol ? count + 1 : count, 0);
        }
        
        maxCountOf(symbol, keeping=this.ringCount || 0) {
          return Math.min(keeping, this.rolledCountOf(symbol));
        }
        
        toString() {
          return this.symbols.join(", ");
        }
      }
      
      class Die extends Rollable {
        get face() {
          this._face || this.roll();
          return this._face;
        }
        
        get symbols() {
          return this.face.split('');
        }
        
        get imageTag() {
          let svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
          svg.setAttribute('viewBox', "0 0 100 100");
          
          let useDie = document.createElementNS('http://www.w3.org/2000/svg', 'use');
          useDie.setAttributeNS('http://www.w3.org/1999/xlink', 'href', `#${this.dieType}-die`);
          useDie.setAttribute('x', 0);
          useDie.setAttribute('y', 0);
          useDie.setAttribute('width', 100);
          useDie.setAttribute('height', 100);
          svg.append(useDie);
          
          let useFace = document.createElementNS('http://www.w3.org/2000/svg', 'use');
          useFace.setAttributeNS('http://www.w3.org/1999/xlink', 'href', `#face-${this.face}`);
          useFace.setAttribute('x', 0);
          useFace.setAttribute('y', 0);
          useFace.setAttribute('width', 100);
          useFace.setAttribute('height', 100);
          svg.append(useFace);
          return svg;
        }
        
        roll() {
          let faces = this.possibleFaces;
          this._face = faces[Math.floor(Math.random() * faces.length)];
        }
        
        toString() {
          return this.face;
        }
      }
      
      class RingDie extends Die {
        get possibleFaces() {return ['-', 'OX', 'O', 'SX', 'S', 'RX'];}
        get dieType() { return 'ring'; }
        toString() { return `[${super.toString()}]`; }
      }
      
      class SkillDie extends Die {
        get possibleFaces() {return ['-', '-', 'O', 'O', 'O', 'SX', 'SX', 'S', 'S', 'SO', 'RX', 'R'];}
        get dieType() { return 'skill'; }
        toString() { return `{${super.toString()}}`; }
      }
      
      class DicePool extends Rollable {
        constructor(ring, skill) {
          super();
          
          this.ringCount = Number(ring);
          this.skillCount = Number(skill);
        
          this.dice = [];
          for (let r = 0; r < this.ringCount; r++) {
            this.dice.push(new RingDie());
          }
          for (let s = 0; s < this.skillCount; s++) {
            this.dice.push(new SkillDie());
          }
        }
        
        get faces() {
          return this.dice.map(d => d.face).sort();
        }
        
        get symbols() {
          return this.dice.flatMap(d => d.symbols).sort();
        }
        
        roll() {
          this.dice.forEach(d => d.roll());
        }
        
        static forDice(dice) {
          let ringCount = dice.reduce((count, d) => d.constructor == RingDie ? count + 1 : count, 0);
          let skillCount = dice.reduce((count, d) => d.constructor == SkillDie ? count + 1 : count, 0);
          return new DicePool(ringCount, skillCount);
        }
      }
      
      function roll(ring, skill) {
        let pool = new DicePool(ring, skill);
        alert(pool.symbols.join("|"));
      }
      
      class Rollbox {
        constructor(root) {
          this.root = root;
        }
        
        get ringCount() { return this.root.querySelector('.rollbox--ring').value; }
        get skillCount() { return this.root.querySelector('.rollbox--skill').value; }
        
        get currentDiceTray() { return this.root.querySelector('.rollbox--current-dice-tray'); }
        get kept() { return this.root.querySelectorAll('.rollbox--keeper---kept'); }
        get keptInFirst() { return this.root.querySelectorAll('.dice-tray:first-of-type .rollbox--keeper---kept'); }
        get keptInCurrent() { return this.root.querySelectorAll('.rollbox--current-dice-tray .rollbox--keeper---kept'); }
        
        get keepsLeft() { return this.ringCount - this.keptInFirst.length; }
        get successes() { return this.keptCount(k => k.die.rolledSuccesses + k.die.rolledExploding); }
        get exploding() { return this.keptCount(k => k.die.rolledExploding, true); }
        get opportunities() { return this.keptCount(k => k.die.rolledOpportunities); }
        get strife() { return this.keptCount(k => k.die.rolledStrife); }
        
        get explodingDice() { return Array.prototype.filter.call(this.keptInCurrent, kept => kept.die.rolledExploding > 0).map(kept => new kept.die.constructor); }
        
        roll() {
          this.rerolls = 0;
          
          this.dicePool = new DicePool(this.ringCount, this.skillCount);
          this.dicePool.roll();

          this.resetTrays();
          this.showDice();
          this.updateOutcome();
        }
        
        rollExploding() {
          let pool = DicePool.forDice(this.explodingDice);
          new DiceTray(this.addDiceTray(), pool).addDice(this);
          this.updateOutcome();
        }
        
        addDiceTray() {
          let trays = this.root.querySelectorAll('.dice-tray');
          let last = trays[trays.length - 1];
          
          let tray = document.createElement('article');
          tray.classList.add('dice-tray');
          last.after(tray);
          
          this.setCurrentDiceTray(tray);
          
          return tray;
        }
        
        setCurrentDiceTray(tray) {
          this.root.querySelectorAll('.dice-tray').forEach(t => {
            t.classList.toggle('rollbox--current-dice-tray', t == tray);
          });
        }
        
        keptCount(fn, onlyCurrent=false) {
          let kept = onlyCurrent ? this.keptInCurrent : this.kept;
          return Array.prototype.map.call(kept, fn).reduce((c, i) => c + i, 0);
        }
        
        resetTrays() {
          this.root.querySelectorAll('.dice-tray:not(.rollbox--current-dice-tray)').forEach(t => t.remove());
        }
        
        showDice() {
          let tray = new DiceTray(this.currentDiceTray, this.dicePool);
          tray.empty();
          tray.addDice(this);
        }
        
        keepChanged(event) {
          let keeper = event.target.closest('.rollbox--keeper');
          keeper.classList.toggle('rollbox--keeper---kept', event.target.checked);
          this.updateOutcome();
        }
        
        updateOutcome() {
          this.root.querySelectorAll('*[data-shows]').forEach(el => {
            el.innerText = this[el.dataset.shows];
          });
          this.root.querySelectorAll('*[data-shown-if]').forEach(el => {
            el.classList.toggle('hidden', !this[el.dataset.shownIf]);
          });
        }
        
        static rooted(el) {
          return el.rollbox = el.rollbox || new Rollbox(el);
        }
      }
      
      class DiceTray {
        constructor(root, dicePool) {
          this.root = root;
          this.dicePool = dicePool;
        }
        
        empty() {
          this.root.innerText = '';
        }
        
        addDice(rollbox) {
          this.dicePool.dice.forEach(die => {
            let keepUi = document.createElement('article');
            keepUi.classList.add('rollbox--keeper');
            keepUi.die = die;
            
            let keepCheckUi = document.createElement('input');
            keepCheckUi.classList.add('sr-only');
            keepCheckUi.setAttribute('type', 'checkbox');
            keepCheckUi.addEventListener('change', e => rollbox.keepChanged(e));
            
            let dieUi = document.createElement('label');
            dieUi.classList.add('die');
            dieUi.append(keepCheckUi);
            dieUi.append(die.imageTag);
            keepUi.append(dieUi);
            
            let actions = document.createElement('article');
            actions.classList.add('rollbox--keeper-actions');
            keepUi.append(actions);
            
            let rerollLink = document.createElement('a');
            rerollLink.setAttribute('href', '#');
            rerollLink.append('reroll');
            rerollLink.addEventListener('click', e => {
              e.preventDefault();
              
              die.roll();
              
              rollbox.rerolls += 1;
              rollbox.updateOutcome();
              
              dieUi.innerText = '';
              dieUi.append(keepCheckUi);
              dieUi.append(die.imageTag);
            });
            actions.append(rerollLink);
            
            this.root.append(keepUi);
          });
        }
      }
      
      document.addEventListener('click', e => {
        if (e.target.matches('.rollbox--trigger')) {
          Rollbox.rooted(e.target.closest('.rollbox')).roll(event);
        } else if (e.target.matches('.rollbox--roll-exploding')) {
          Rollbox.rooted(e.target.closest('.rollbox')).rollExploding(event);
        }
      })
      
      document.querySelector('.rollbox--trigger').click();
    </script>
    <style>
      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        margin: -1px;
        padding: 0;
        overflow: hidden;
        clip: rect(0 0 0 0);
        border: 0;
      }
      
      .rollbox {
        border: 1px solid #ccc;
        border-radius: 3px;
        box-shadow: 3px 3px 3px #ddd;
        padding: 10px;
        margin: 10px;
      }
      
        .rollbox--header {
          font-size: 150%;
          padding-bottom: 5px;
          margin-bottom: 10px;
          border-bottom: 1px solid #ccc;
        }
        
          .rollbox--header input {
            width: 5ch;
          }
      
        .rollbox--roll-exploding {
          font-size: 150%;
          border: 1px solid #ccc;
          padding: 5px 25px;
          border-radius: 3;
          display: inline-block;
          animation: rumble 1s infinite;
        }
        
        @keyframes rumble {
            0% { transform: translate( 0px) rotate( 0deg); }
           10% { transform: translate( 2px) rotate( 1deg); }
           20% { transform: translate(-2px) rotate(-1deg); }
           30% { transform: translate(-3px) rotate( 1deg); }
           40% { transform: translate( 4px) rotate(-1deg); }
           50% { transform: translate( 0px) rotate( 2deg); }
           60% { transform: translate(-1px) rotate( 1deg); }
           70% { transform: translate(-4px) rotate( 2deg); }
           80% { transform: translate( 2px) rotate( 1deg); }
           90% { transform: translate( 1px) rotate(-1deg); }
          100% { transform: translate(-2px) rotate(-1deg); }
        }
        
        .rollbox--outcome {
          margin-top: 10px;
          display: grid;
          grid-template-columns: 1fr 10fr;
        }
        
        .rollbox--outcome dt {
          text-align: end;
          padding-right: 1em;
        }
        
        .dice-tray {
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
          grid-gap: 5px;
          padding: 5px 0;
        }
        
        .rollbox--keeper {
          border: 1px solid #ccc;
          border-radius: 3px;
          display: flex;
        }
          .rollbox--keeper label:focus-within {
            outline: 2px solid blue;
            outline-color: -webkit-focus-ring-color;
          }
        
          .rollbox--keeper---kept {
            background-color: #ccc;
          }
          
          .rollbox--keeper label {
            padding: 5px;
            font-size: 200%;
            flex-grow: 1;
          }
          
          .rollbox--keeper-actions {
            border-left: 1px solid #ccc;
            display: flex;
            flex-direction: column;
            font-size: 80%;
          }
          
            .rollbox--keeper-actions a {
              padding: 5px;
            }
    </style>
</html>
